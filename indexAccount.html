<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>EC-wallet</title>
    <script src="./js/vue.js"></script>
    <link rel="stylesheet" href="./css/base.css">
    <link rel="stylesheet" href="./css/bootstrap.min.css">
    <link rel="stylesheet" href="./css/indexAccount.css">
    <script src="./js/jquery.min.js"></script>
    <script src="./js/bootstrap.min.js"></script>
    <script src="./js/ethers-io.js"></script>

</head>

<body>

    <div id="app3">
        <nav class="navbar navbar-expand-sm bg-light">
            <ul class="header-nav">
                <li class="li"><a href="http://explorer.coin.ec/home" target="_blank"><img src="./img/6.png" alt=""></a>
                </li>
                <li class="li"><a href="./index.html">首页</a></li>
                <li class="li"><a href="./transfer.html">转账</a></li>
                <li class="li"><a href="./contacts.html">联系人</a></li>
                <li class="li"><a href="./setting.html">设置</a></li>
            </ul>
        </nav>
        <div class="home-banner">

            <div class="active-icon">
                <button class="inter-btn" @click="transferAccount()">发起转账</button>
                <button class="inter-btn" @click="copyMemory">助记词</button>
                <button class="inter-btn" @click="QRcode">二维码</button>

            </div>


            <div class="account-center" style="margin-top: 30px;position:absolute;margin-left:560px;line-height: 30px">
                <div> 
                    <span>{{username}}</span>
                    <img src="./img/modify.png" alt="" style="width: 16px;height:16px;cursor: pointer;" @click="modifyAccount">
                </div>
                <div >
                    <h1 >{{balance}} EC</h1>
                </div>
                <div> 
                    <span>{{address}}</span>
                    <img src="./img/copy.png" alt="" style="width: 16px;height:16px;cursor: pointer;" @click="copyAddress">
                </div>





            </div>

        </div>

        <!-- 背景 -->
        <div class="addbg"></div>

        <!-- 助记词弹窗 -->
        <div class="memory">
            <div>
                <div class="head">
                    <span style="font-size: 20px">复制</span>
                    <i @click="cancel"></i>
                </div>
                <div class="body">
                    <textarea name="" id="" cols="30" rows="10">{{memory}}</textarea>
                </div>
                <div class="foot">
                    <button class="btn btn-secondary" @click="confirmCopy">复制</button>
                    <button class="btn btn-primary" @click="download">下载助记词</button>
                </div>
            </div>
        </div>

        <!-- 账号备注弹窗 -->

        <div class="modifyAccount">
            <div>
                <div class="headAccount">
                        <i @click="cancelModify"></i>
                    <h3>修改备注</h3>
                   
                </div>
                <div class="bodyAccount">
                    <input type="text" style="width: 90%" v-model="username">
                </div>
                <div class="footAccount">
                    <button class="btn btn-secondary" @click="cancelModify">取消</button>
                    <button class="btn btn-primary" style="margin-left: 10px" @click="confirmModify">确认</button>
                </div>

            </div>
        </div>
        <!-- 二维码弹窗 -->

        <div class="QRcode">
            <div>
                <div class="qrHead">
                    <i @click="cancelQR"></i>
                   <h3>提示</h3>
                </div>
                <div class="qrBody">
                    <img src="./img/QRcode.png" alt="" width="200px" height="200px">

                </div>
                <div class="qrFoot">
                    <span>{{address}}</span>

                </div>
            </div>

        </div>







    </div>

    <script>
        var vm = new Vue({
            el: '#app3',
            data: {
                username: '',
                address: '',
                memory: '',
                balance: '',

            },
            created() {
                let url = location.search //获取url中?和之后的字符串('?pickUsername=pickUsername&pickWallet=pickWallet')
                let theRequest = new Object();
                if (url.indexOf("?") != -1) {
                    let str = url.substr(1)//返回?后面参数字符串
                    //let strs = str.split("&");
                    //将字符串转化为对象
                    // for (var i = 0; i < str.length; i++) {
                    //     theRequest[str[i].split("=")[0]] = (str[i].split("=")[1])
                    // }

                    //将address以键值对的形式赋值给tehRequest
                    theRequest[str.split("=")[0]] = str.split("=")[1]

                    // return console.log(theRequest) //theRequest 是参数
                    //this.username = theRequest.pickUsername
                    this.address = theRequest.pickAddress
                    //this.memory = theRequest.pickMnemonic

                    let list = JSON.parse(localStorage.getItem("wallets"))
                    let ret = list.find(i => i.wallet.signingKey.address == this.address)

                    this.username = ret.username
                    this.memory = ret.wallet.signingKey.mnemonic
                    //获取余额
                    //let provider = new ethers.providers.JsonRpcProvider('https://ropsten.infura.io/v3/2d6036eb41204013a6bf8606be3e0931', 'ropsten')
                    //let provider = new ethers.providers.JsonRpcProvider('http://rpc.coin.ec/ ', 'ropsten')
                    let provider
                    if (localStorage.getItem('peers')) {
                        provider = new ethers.providers.JsonRpcProvider(localStorage.getItem('peers'), 'ropsten')
                    } else {
                        provider = ethers.getDefaultProvider('ropsten')
                    }
                    provider.getBalance(this.address).then((balances) => {
                        this.balance = ethers.utils.formatEther(balances);

                    });



                }

            },
            methods: {
                transferAccount: function () {
                    location.href = "./transfer.html"

                },
                copyMemory: function () {
                    //弹出助记词框
                    //    document.getElementsByClassName('adduse-input-key')[0].style.transform = "translateY(-80px)";
                    // document.getElementsByClassName('adduse-input-key')[0].style.opacity = '0'
                    // document.getElementsByClassName('adduse-input-key')[0].style.zIndex = '-1'
                    // document.getElementsByClassName('addbg')[0].style.display = 'none'
                    let mem = document.getElementsByClassName("memory")[0]
                    mem.style.transform = "translateY(80px)"
                    mem.style.opacity = "1"
                    mem.style.zIndex = "100"
                    document.getElementsByClassName("addbg")[0].style.display = "block"


                },
                //弹出修改备注框
                modifyAccount:function(){
                    let acc = document.getElementsByClassName("modifyAccount")[0]
                    acc.style.transform = "translateY(80px)"
                    acc.style.opacity="1"
                    acc.style.zIndex="100"
                    document.getElementsByClassName("addbg")[0].style.display = "block"
                },

                copyAddress:function(){
                    const input = document.createElement('input')
                    document.body.appendChild(input)
                    input.setAttribute('value', this.address)
                    input.select()
                    if (document.execCommand('copy')) {
                        document.execCommand('copy')
                    }
                    document.body.removeChild(input)
                    this.cancel()
                    window.alert('复制成功')
                },
                //二维码弹窗
                QRcode: function () {
                    let qr = document.getElementsByClassName("QRcode")[0]
                    qr.style.transform = "translateY(80px)"
                    qr.style.opacity = "1"
                    qr.style.zIndex = "100"
                    document.getElementsByClassName("addbg")[0].style.display = "block"

                },
                //取消二维码弹窗
                cancelQR:function(){
                    let qr = document.getElementsByClassName("QRcode")[0]
                    qr.style.transform = "translateY(-80px)"
                    qr.style.opacity = "0"
                    qr.style.zIndex = "-1"
                    document.getElementsByClassName("addbg")[0].style.display = "none"


                },
                cancel: function () {
                    let mem = document.getElementsByClassName("memory")[0]
                    mem.style.transform = "translateY(-80px)"
                    mem.style.opacity = "0"
                    mem.style.zIndex = "-1"
                    document.getElementsByClassName("addbg")[0].style.display = "none"
                },
                cancelModify:function(){
                    let acc = document.getElementsByClassName("modifyAccount")[0]
                    acc.style.transform = "translateY(-80px)"
                    acc.style.opacity="0"
                    acc.style.zIndex="-1"
                    document.getElementsByClassName("addbg")[0].style.display = "none"
                },
                //下载助记词
                download: function () {
                    // 创建隐藏的可下载链接
                    let content = `{"mnemonic":"${this.memory}"}`
                    var eleLink = document.createElement('a');
                    eleLink.download = 'mnemonic.txt';
                    eleLink.style.display = 'none';
                    // 字符内容转变成blob地址
                    var blob = new Blob([content]);
                    eleLink.href = URL.createObjectURL(blob);
                    // 触发点击
                    document.body.appendChild(eleLink);
                    eleLink.click();
                    // 然后移除
                    document.body.removeChild(eleLink);

                    this.cancel();



                },
                //复制助记词
                confirmCopy: function () {
                    const input = document.createElement('input')
                    document.body.appendChild(input)
                    input.setAttribute('value', this.memory)
                    input.select()
                    if (document.execCommand('copy')) {
                        document.execCommand('copy')
                    }
                    document.body.removeChild(input)
                    this.cancel()
                    window.alert('复制成功')

                },
                //确认修改账号备注
                confirmModify:function(){
                    let lists = JSON.parse(localStorage.getItem('wallets'))
                    //匹配的账号
                  let item =  lists.find(i=>i.wallet.signingKey.address==this.address)
                  let index = lists.findIndex(i=>i.wallet.signingKey.address==this.address)
                  //新备注名赋值给账户
                  item.username = this.username
                  lists.splice(index,1,item)
                  localStorage.setItem('wallets',JSON.stringify(lists))
                  this.cancelModify()            
                }




            }
        })

    </script>
</body>

</html>